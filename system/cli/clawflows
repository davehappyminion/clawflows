#!/usr/bin/env bash
set -euo pipefail

# ── Config ──────────────────────────────────────────────────────────────────
# Resolve symlinks so this works when called via ~/.local/bin/clawflows
SELF="$0"
if [ -L "$SELF" ]; then
  SELF="$(readlink "$SELF")"
fi
CLAWFLOWS_DIR="$(cd "$(dirname "$SELF")/../.." && pwd)"
AGENTS_MD="${AGENTS_MD:-$HOME/.openclaw/workspace/AGENTS.md}"
AVAILABLE_DIR="$CLAWFLOWS_DIR/workflows/available"
ENABLED_DIR="$CLAWFLOWS_DIR/workflows/enabled"
BIN_TARGET="$HOME/.local/bin/clawflows"

START_MARKER="<!-- clawflows:start -->"
END_MARKER="<!-- clawflows:end -->"

# ── Helpers ─────────────────────────────────────────────────────────────────

cmd_help() {
  cat <<'EOF'

  ⚡️ ClawFlows — Superpowers for your OpenClaw agent

  Usage: clawflows <command> [args]

  Browsing
    list                 Show all workflows (enabled + available)
    list enabled         Show only enabled workflows
    list available       Show only available workflows

  Managing
    enable <name>        Turn on a workflow
    disable <name>       Turn off a workflow

  Maintenance
    update               Pull the latest workflows from GitHub
    sync                 Refresh your agent's workflow list in AGENTS.md
    uninstall            Remove clawflows and clean up

  Info
    help, --help, -h     Show this help

  Examples
    clawflows list                          See everything
    clawflows enable send-morning-briefing  Turn on morning briefings
    clawflows disable check-x               Turn off X/Twitter workflow
    clawflows update                        Get new workflows

  How it works
    Workflows live in ~/.openclaw/workspace/clawflows/workflows/
    • available/  — all workflows from the repo
    • enabled/    — the ones you've turned on (copied from available)

    When you enable or disable a workflow, your agent's AGENTS.md is
    updated automatically so it knows what's available.

    Scheduled workflows run automatically via the clawflows-scheduler
    cron job (set up during install, checks every 15 min).

EOF
}

die() { echo "error: $1" >&2; exit 1; }

# Extract a frontmatter field from a WORKFLOW.md file.
get_field() {
  local file="$1" field="$2"
  awk -v field="$field" '
    BEGIN { in_fm=0 }
    /^---$/ { in_fm++; next }
    in_fm == 1 && $0 ~ "^" field ":" {
      sub("^" field ":[ ]*", "")
      gsub(/^["'"'"']|["'"'"']$/, "")
      print
      exit
    }
    in_fm >= 2 { exit }
  ' "$file"
}

# Build a line for a workflow: emoji + name + description
_workflow_line() {
  local dir="$1"
  local name emoji desc label
  name="$(basename "$dir")"
  emoji=""
  desc=""
  if [ -f "$dir/WORKFLOW.md" ]; then
    emoji="$(get_field "$dir/WORKFLOW.md" emoji)"
    desc="$(get_field "$dir/WORKFLOW.md" description)"
  fi
  label="${emoji:+$emoji }$name"
  if [ -n "$desc" ]; then
    printf "    %-40s %s" "$label" "$desc"
  else
    printf "    %s" "$label"
  fi
}

# ── Commands ────────────────────────────────────────────────────────────────

cmd_list() {
  local filter="${1:-all}"
  local name found=false
  local enabled_lines=()
  local available_lines=()

  for dir in "$AVAILABLE_DIR"/*/; do
    [ -d "$dir" ] || continue
    found=true
    name="$(basename "$dir")"

    if [ -d "$ENABLED_DIR/$name" ]; then
      enabled_lines+=("$(_workflow_line "$dir")")
    else
      available_lines+=("$(_workflow_line "$dir")")
    fi
  done

  if ! $found; then
    echo ""
    echo "  No workflows found."
    echo ""
    echo "  Make sure clawflows is installed correctly:"
    echo "    curl -fsSL https://raw.githubusercontent.com/davehappyminion/clawflows/main/system/install.sh | bash"
    echo ""
    return
  fi

  if [ "$filter" = "all" ] || [ "$filter" = "enabled" ]; then
    if [ ${#enabled_lines[@]} -gt 0 ]; then
      echo ""
      echo "  Enabled (${#enabled_lines[@]})"
      echo "  ─────────"
      for line in "${enabled_lines[@]}"; do
        echo "$line"
      done
    elif [ "$filter" = "enabled" ]; then
      echo ""
      echo "  No workflows enabled yet."
      echo "  Run 'clawflows list' to see what's available."
    fi
  fi

  if [ "$filter" = "all" ] || [ "$filter" = "available" ]; then
    if [ ${#available_lines[@]} -gt 0 ]; then
      echo ""
      echo "  Available (${#available_lines[@]})"
      echo "  ───────────"
      for line in "${available_lines[@]}"; do
        echo "$line"
      done
    fi
  fi

  echo ""
  echo "  clawflows enable <name>    Turn on a workflow"
  echo "  clawflows disable <name>   Turn off a workflow"
}

cmd_enable() {
  local name="$1"
  [ -d "$AVAILABLE_DIR/$name" ] || die "workflow '$name' not found in available/"
  if [ -d "$ENABLED_DIR/$name" ]; then
    echo "already enabled: $name"
    return
  fi
  cp -r "$AVAILABLE_DIR/$name" "$ENABLED_DIR/$name"
  echo "enabled: $name"
  cmd_sync
}

cmd_disable() {
  local name="$1"
  if [ ! -d "$ENABLED_DIR/$name" ]; then
    echo "not enabled: $name"
    return
  fi
  rm -rf "$ENABLED_DIR/$name"
  echo "disabled: $name"
  cmd_sync
}

cmd_update() {
  echo "Updating clawflows..."
  if git -C "$CLAWFLOWS_DIR" pull --ff-only --quiet 2>/dev/null; then
    echo "Updated to latest version."
  else
    echo "Could not update (offline or local changes). Try: git -C $CLAWFLOWS_DIR pull"
    return 1
  fi
  cmd_sync
}

cmd_uninstall() {
  echo ""
  echo "  This will remove:"
  echo "    • CLI symlink at $BIN_TARGET"
  echo "    • ClawFlows section from AGENTS.md"
  echo "    • Scheduler cron job"
  echo ""
  echo "  Your enabled workflows in $ENABLED_DIR/ will NOT be deleted."
  echo "  The repo at $CLAWFLOWS_DIR/ will NOT be deleted."
  echo ""
  printf "  Are you sure? [y/N] "
  read -r confirm
  if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
    echo "  Cancelled."
    return
  fi

  # Remove symlink
  if [ -L "$BIN_TARGET" ]; then
    rm -f "$BIN_TARGET"
    echo "  Removed $BIN_TARGET"
  fi

  # Remove AGENTS.md block
  if [ -f "$AGENTS_MD" ] && grep -qF "$START_MARKER" "$AGENTS_MD"; then
    local tmpfile
    tmpfile="$(mktemp)"
    awk -v start="$START_MARKER" -v end="$END_MARKER" '
      $0 == start { skip=1; next }
      $0 == end   { skip=0; next }
      !skip       { print }
    ' "$AGENTS_MD" > "$tmpfile"
    mv "$tmpfile" "$AGENTS_MD"
    echo "  Removed ClawFlows section from AGENTS.md"
  fi

  # Remove scheduler cron
  if command -v openclaw >/dev/null 2>&1; then
    openclaw cron remove --name "clawflows-scheduler" </dev/null >/dev/null 2>&1 || true
    echo "  Removed scheduler cron"
  fi

  echo ""
  echo "  Done. To fully remove, also run:"
  echo "    rm -rf $CLAWFLOWS_DIR"
  echo ""
}

cmd_sync() {
  local block
  block="$(_build_block)"

  if [ ! -f "$AGENTS_MD" ]; then
    die "AGENTS.md not found at $AGENTS_MD"
  fi

  if grep -qF "$START_MARKER" "$AGENTS_MD"; then
    _replace_block "$block"
  else
    printf "\n%s\n" "$block" >> "$AGENTS_MD"
  fi

  echo "synced AGENTS.md"
}

# ── Block builder ───────────────────────────────────────────────────────────

_build_block() {
  local lines=()

  lines+=("$START_MARKER")
  lines+=("## ClawFlows")
  lines+=("")
  lines+=("Workflows from \`$CLAWFLOWS_DIR/\`. When the user asks you to do something that matches an enabled workflow, read its WORKFLOW.md and follow the steps.")
  lines+=("")
  lines+=("### Running a Workflow")
  lines+=("1. Read the WORKFLOW.md file listed next to the workflow below")
  lines+=("2. Follow the steps in the file exactly")
  lines+=("3. If the workflow isn't enabled yet, run \`clawflows enable <name>\` first")
  lines+=("")
  lines+=("### CLI Commands")
  lines+=("- \`clawflows list\` — see all workflows (enabled + available)")
  lines+=("- \`clawflows list enabled\` — see only what's turned on")
  lines+=("- \`clawflows list available\` — see what else is available")
  lines+=("- \`clawflows enable <name>\` — turn on a workflow")
  lines+=("- \`clawflows disable <name>\` — turn off a workflow")
  lines+=("- \`clawflows update\` — pull the latest workflows from GitHub")
  lines+=("- \`clawflows sync\` — refresh this list after manual changes")
  lines+=("")

  local has_enabled=false
  local entries=()
  for dir in "$ENABLED_DIR"/*/; do
    [ -d "$dir" ] || continue
    local name desc schedule wf_file
    name="$(basename "$dir")"
    [ "$name" = ".gitkeep" ] && continue
    wf_file="$dir/WORKFLOW.md"
    [ -f "$wf_file" ] || continue
    desc="$(get_field "$wf_file" description)"
    schedule="$(get_field "$wf_file" schedule)"
    if [ -n "$schedule" ]; then
      entries+=("- **$name** ($schedule): $desc → \`$CLAWFLOWS_DIR/workflows/enabled/$name/WORKFLOW.md\`")
    else
      entries+=("- **$name** (on-demand): $desc → \`$CLAWFLOWS_DIR/workflows/enabled/$name/WORKFLOW.md\`")
    fi
    has_enabled=true
  done

  if $has_enabled; then
    lines+=("### Enabled Workflows")
    lines+=("When the user asks for any of these, read the WORKFLOW.md file and follow it.")
    for entry in "${entries[@]}"; do
      lines+=("$entry")
    done
  else
    lines+=("No workflows enabled yet. Run \`clawflows list\` to see what's available.")
  fi

  lines+=("$END_MARKER")

  printf '%s\n' "${lines[@]}"
}

_replace_block() {
  local new_block="$1"
  local tmpfile blockfile
  tmpfile="$(mktemp)"
  blockfile="$(mktemp)"

  printf '%s\n' "$new_block" > "$blockfile"

  awk -v start="$START_MARKER" -v end="$END_MARKER" -v bf="$blockfile" '
    $0 == start { while ((getline line < bf) > 0) print line; close(bf); skip=1; next }
    $0 == end   { skip=0; next }
    !skip       { print }
  ' "$AGENTS_MD" > "$tmpfile"

  mv "$tmpfile" "$AGENTS_MD"
  rm -f "$blockfile"
}

# ── Main ────────────────────────────────────────────────────────────────────

[ $# -ge 1 ] || { cmd_help; exit 0; }

case "$1" in
  list)      cmd_list "${2:-all}" ;;
  enable)    [ $# -ge 2 ] || die "usage: clawflows enable <name>"; cmd_enable "$2" ;;
  disable)   [ $# -ge 2 ] || die "usage: clawflows disable <name>"; cmd_disable "$2" ;;
  update)    cmd_update ;;
  uninstall) cmd_uninstall ;;
  sync)      cmd_sync ;;
  help|--help|-h) cmd_help ;;
  *)         cmd_help ;;
esac
