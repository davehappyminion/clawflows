#!/usr/bin/env bash
set -euo pipefail

# â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Resolve symlinks so this works when called via ~/.local/bin/clawflows
SELF="$0"
if [ -L "$SELF" ]; then
  SELF="$(readlink "$SELF")"
fi
CLAWFLOWS_DIR="$(cd "$(dirname "$SELF")/../.." && pwd)"

# Detect OpenClaw workspace (supports custom workspace directories)
_oc_workspace=""
if [ -f "$HOME/.openclaw/openclaw.json" ]; then
  _oc_workspace="$(grep -o '"workspace"[[:space:]]*:[[:space:]]*"[^"]*"' "$HOME/.openclaw/openclaw.json" | sed 's/.*:.*"\([^"]*\)"/\1/' | head -1 || true)"
fi
_oc_workspace="${_oc_workspace:-$HOME/.openclaw/workspace}"

AGENTS_MD="${AGENTS_MD:-$_oc_workspace/AGENTS.md}"
BACKUP_DIR="${BACKUP_DIR:-$_oc_workspace/clawflows-backups}"
COMMUNITY_DIR="$CLAWFLOWS_DIR/workflows/available/community"
CUSTOM_DIR="$CLAWFLOWS_DIR/workflows/available/custom"
ENABLED_DIR="$CLAWFLOWS_DIR/workflows/enabled"
SUBMISSIONS_DIR="$CLAWFLOWS_DIR/community-submissions"
BIN_TARGET="$HOME/.local/bin/clawflows"

START_MARKER="<!-- clawflows:start -->"
END_MARKER="<!-- clawflows:end -->"

# â”€â”€ Find openclaw (may not be in PATH when run from a non-interactive shell) â”€â”€
_find_openclaw() {
  if command -v openclaw >/dev/null 2>&1; then
    echo "openclaw"
    return
  fi
  for try_path in "$HOME/.local/bin/openclaw" "/usr/local/bin/openclaw" "/opt/homebrew/bin/openclaw"; do
    if [ -x "$try_path" ]; then
      echo "$try_path"
      return
    fi
  done
}

# â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cmd_help() {
  cat <<'EOF'

  âš¡ï¸ ClawFlows â€” Superpowers for your OpenClaw agent

  Usage: clawflows <command> [args]

  Browsing
    list                 Show all workflows (enabled + available)
    list enabled         Show only enabled workflows
    list available       Show only available workflows

  Creating
    create               Create a new custom workflow (interactive)
    create --from-json   Create from JSON (for agents)

  Running
    run <name>           Run a workflow now (invokes your agent)

  Managing
    enable <name>        Turn on a workflow (symlinks to enabled/)
    disable <name>       Turn off a workflow (removes symlink)
    edit <name>          Copy a community workflow to custom/ for editing
    open <name>          Open a workflow in your editor
    validate <name>      Check a workflow has required fields
    submit <name>        Submit a custom workflow for community review

  Backup
    backup               Back up custom workflows and enabled list
    restore              Restore from a backup

  Maintenance
    update               Pull the latest workflows from GitHub
    sync-agent           Refresh your agent's workflow list in AGENTS.md
    uninstall            Remove clawflows and clean up

  Info
    help, --help, -h     Show this help

  Examples
    clawflows run send-morning-briefing     Run a workflow right now
    clawflows create                        Create a new custom workflow
    clawflows list                          See everything
    clawflows enable send-morning-briefing  Turn on morning briefings
    clawflows edit send-morning-briefing    Make your own version
    clawflows open send-morning-briefing    Open in your editor
    clawflows disable check-x               Turn off X/Twitter workflow
    clawflows validate my-workflow          Check your workflow is valid
    clawflows submit my-workflow            Share your workflow with the community
    clawflows update                        Get new community workflows

  How it works
    Workflows live in ~/.openclaw/workspace/clawflows/workflows/
    â€¢ available/community/  â€” from the repo (updated via git)
    â€¢ available/custom/     â€” your own workflows (gitignored)
    â€¢ enabled/              â€” symlinks to active workflows

    When you enable a workflow, a symlink is created. Disable removes
    the symlink â€” your custom workflows are never deleted.

    Use 'edit' to copy a community workflow to custom/ so you
    can modify it without losing changes on update. Use 'open' to
    open any workflow in your editor.

EOF
}

die() { echo "error: $1" >&2; exit 1; }

# Extract a frontmatter field from a WORKFLOW.md file.
get_field() {
  local file="$1" field="$2"
  awk -v field="$field" '
    BEGIN { in_fm=0 }
    /^---$/ { in_fm++; next }
    in_fm == 1 && $0 ~ "^" field ":" {
      sub("^" field ":[ ]*", "")
      gsub(/^["'"'"']|["'"'"']$/, "")
      print
      exit
    }
    in_fm >= 2 { exit }
  ' "$file"
}

# Find workflow source: custom/ takes priority over community/
_find_workflow() {
  local name="$1"
  if [ -d "$CUSTOM_DIR/$name" ]; then
    echo "$CUSTOM_DIR/$name"
  elif [ -d "$COMMUNITY_DIR/$name" ]; then
    echo "$COMMUNITY_DIR/$name"
  fi
}

# Build a line for a workflow: emoji + name + description
_workflow_line() {
  local dir="$1"
  local name emoji desc label
  name="$(basename "$dir")"
  emoji=""
  desc=""
  if [ -f "$dir/WORKFLOW.md" ]; then
    emoji="$(get_field "$dir/WORKFLOW.md" emoji)"
    desc="$(get_field "$dir/WORKFLOW.md" description)"
  fi
  label="${emoji:+$emoji }$name"
  if [ -n "$desc" ]; then
    printf "    %-40s %s" "$label" "$desc"
  else
    printf "    %s" "$label"
  fi
}

# â”€â”€ Commands â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Create workflow from JSON (for agent/programmatic use)
_create_from_json() {
  local json="$1"

  if [ -z "$json" ]; then
    json="$(cat)"
  fi

  if [ -z "$json" ]; then
    die "No JSON provided. Usage: clawflows create --from-json '{...}' or pipe JSON to stdin"
  fi

  # Parse JSON fields (|| true for optional fields that may not exist)
  local name emoji summary schedule author description
  name="$(echo "$json" | grep -o '"name"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/.*:.*"\([^"]*\)"/\1/' | head -1 || true)"
  emoji="$(echo "$json" | grep -o '"emoji"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/.*:.*"\([^"]*\)"/\1/' | head -1 || true)"
  summary="$(echo "$json" | grep -o '"summary"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/.*:.*"\([^"]*\)"/\1/' | head -1 || true)"
  schedule="$(echo "$json" | grep -o '"schedule"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/.*:.*"\([^"]*\)"/\1/' | head -1 || true)"
  author="$(echo "$json" | grep -o '"author"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/.*:.*"\([^"]*\)"/\1/' | head -1 || true)"
  description="$(echo "$json" | grep -o '"description"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/.*:.*"\([^"]*\)"/\1/' | head -1 || true)"

  # Validate required fields
  [ -n "$name" ] || die "Missing required field: name"
  [ -n "$summary" ] || die "Missing required field: summary"
  [ -n "$description" ] || die "Missing required field: description"

  # Defaults
  emoji="${emoji:-ğŸ”§}"

  # Check if already exists
  if [ -d "$CUSTOM_DIR/$name" ] || [ -d "$COMMUNITY_DIR/$name" ]; then
    die "Workflow '$name' already exists"
  fi

  # Build the WORKFLOW.md content
  local workflow_content="---
name: $name
emoji: $emoji
description: $summary"

  if [ -n "$schedule" ]; then
    workflow_content="$workflow_content
schedule: \"$schedule\""
  fi

  if [ -n "$author" ]; then
    workflow_content="$workflow_content
author: $author"
  fi

  local title
  title="$(echo "${name//-/ }" | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2))}1')"

  workflow_content="$workflow_content
---

# $title

$description
"

  # Create in custom/ directory
  local workflow_dir="$CUSTOM_DIR/$name"
  mkdir -p "$workflow_dir"
  printf '%s' "$workflow_content" > "$workflow_dir/WORKFLOW.md"

  echo "âœ“ Created $workflow_dir/WORKFLOW.md"

  # Auto-enable it
  cmd_enable "$name"

  # Show how to use it
  echo ""
  echo "To run: ask your agent \"Run $name\""
  if [ -n "$schedule" ]; then
    echo "Scheduled: $schedule"
  fi
  echo "To edit: $workflow_dir/WORKFLOW.md"
}

cmd_create() {
  if [ "${1:-}" = "--from-json" ]; then
    _create_from_json "${2:-}"
    return
  fi

  echo ""
  echo "  âš¡ï¸ Create a new workflow"
  echo ""

  # 1. Name
  local name=""
  while [ -z "$name" ]; do
    printf "  Name (e.g., check-water-intake): "
    read -r name
    if [ -n "$name" ]; then
      name="$(echo "$name" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')"
      # Suggest a verb-prefixed name if they didn't use one
      if ! echo "$name" | grep -qE '^(activate|process|check|build|send|sync|track|draft|review|plan|prep|curate|summarize|backup|clean|rotate|find)-'; then
        echo "  ğŸ’¡ Tip: names usually start with a verb like check-$name or track-$name"
      fi
      if [ -d "$CUSTOM_DIR/$name" ] || [ -d "$COMMUNITY_DIR/$name" ]; then
        echo "  âš ï¸  Workflow '$name' already exists"
        name=""
        continue
      fi
    fi
  done

  # 2. Emoji
  printf "  Emoji (e.g., ğŸ’§): "
  read -r emoji
  emoji="${emoji:-ğŸ”§}"

  # 3. Summary
  local summary=""
  while [ -z "$summary" ]; do
    printf "  One-line summary: "
    read -r summary
  done

  # 4. Schedule
  echo ""
  echo "  When should it run?"
  echo "    Examples: \"9am\", \"9am, 5pm\", \"8am, 12pm, 4pm, 8pm\""
  echo "    Leave blank for on-demand only"
  printf "  Schedule: "
  read -r schedule

  # 5. Author
  echo ""
  echo "  Your name (optional, for credit)"
  echo "    GitHub username, @twitter, or both: \"nikilster @nikil\""
  printf "  You: "
  read -r author

  # 6. Description
  echo ""
  echo "  Describe what this workflow does."
  echo "  What should the agent do when running it? Be specific."
  echo "  (Enter a blank line when done)"
  echo ""
  local description=""
  local line
  while IFS= read -r line; do
    [ -z "$line" ] && break
    if [ -z "$description" ]; then
      description="$line"
    else
      description="$description"$'\n'"$line"
    fi
  done

  # Build content
  local workflow_content="---
name: $name
emoji: $emoji
description: $summary"

  if [ -n "$schedule" ]; then
    workflow_content="$workflow_content
schedule: \"$schedule\""
  fi

  if [ -n "$author" ]; then
    workflow_content="$workflow_content
author: $author"
  fi

  local title
  title="$(echo "${name//-/ }" | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2))}1')"

  workflow_content="$workflow_content
---

# $title

$description
"

  # Create in custom/ directory
  local workflow_dir="$CUSTOM_DIR/$name"
  mkdir -p "$workflow_dir"
  printf '%s' "$workflow_content" > "$workflow_dir/WORKFLOW.md"

  echo ""
  echo "  âœ“ Created $workflow_dir/WORKFLOW.md"
  echo ""
  echo "  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "$workflow_content" | sed 's/^/  /'
  echo "  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""

  # Auto-enable
  cmd_enable "$name"

  echo ""
  echo "  Your workflow is ready!"
  echo ""
  echo "  To run:  ask your agent \"Run $name\""
  if [ -n "$schedule" ]; then
    echo "  Scheduled: $schedule"
  fi
  echo "  To edit: $workflow_dir/WORKFLOW.md"
  echo ""
}

cmd_list() {
  local filter="${1:-all}"
  local name dir found=false
  local enabled_lines=()
  local available_lines=()
  local seen_names=""

  # Collect workflows from custom/ first (takes priority), then community/
  for dir in "$CUSTOM_DIR"/*/; do
    [ -d "$dir" ] || continue
    name="$(basename "$dir")"
    [ "$name" = ".gitkeep" ] && continue
    seen_names="$seen_names $name "
    found=true

    if [ -L "$ENABLED_DIR/$name" ] || [ -d "$ENABLED_DIR/$name" ]; then
      enabled_lines+=("$(_workflow_line "$dir")")
    else
      available_lines+=("$(_workflow_line "$dir")")
    fi
  done

  for dir in "$COMMUNITY_DIR"/*/; do
    [ -d "$dir" ] || continue
    name="$(basename "$dir")"
    # Skip if already seen in custom/
    case "$seen_names" in
      *" $name "*) continue ;;
    esac
    found=true

    if [ -L "$ENABLED_DIR/$name" ] || [ -d "$ENABLED_DIR/$name" ]; then
      enabled_lines+=("$(_workflow_line "$dir")")
    else
      available_lines+=("$(_workflow_line "$dir")")
    fi
  done

  if ! $found; then
    echo ""
    echo "  No workflows found."
    echo ""
    echo "  Make sure clawflows is installed correctly:"
    echo "    curl -fsSL https://raw.githubusercontent.com/davehappyminion/clawflows/main/system/install.sh | bash"
    echo ""
    return
  fi

  if [ "$filter" = "all" ] || [ "$filter" = "enabled" ]; then
    if [ ${#enabled_lines[@]} -gt 0 ]; then
      echo ""
      echo "  Enabled (${#enabled_lines[@]})"
      echo "  â”€â”€â”€â”€â”€â”€â”€â”€â”€"
      for line in "${enabled_lines[@]}"; do
        echo "$line"
      done
    elif [ "$filter" = "enabled" ]; then
      echo ""
      echo "  No workflows enabled yet."
      echo "  Run 'clawflows list' to see what's available."
    fi
  fi

  if [ "$filter" = "all" ] || [ "$filter" = "available" ]; then
    if [ ${#available_lines[@]} -gt 0 ]; then
      echo ""
      echo "  Available (${#available_lines[@]})"
      echo "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
      for line in "${available_lines[@]}"; do
        echo "$line"
      done
    fi
  fi

  echo ""
  echo "  clawflows enable <name>    Turn on a workflow"
  echo "  clawflows disable <name>   Turn off a workflow"
}

cmd_enable() {
  local name="$1"
  local source_dir
  source_dir="$(_find_workflow "$name")"

  [ -n "$source_dir" ] || die "workflow '$name' not found"

  if [ -L "$ENABLED_DIR/$name" ] || [ -d "$ENABLED_DIR/$name" ]; then
    echo "already enabled: $name"
    return
  fi

  # Create symlink
  ln -s "$source_dir" "$ENABLED_DIR/$name"
  echo "enabled: $name"

  # If this workflow has a schedule, ensure the scheduler cron is set up
  local schedule
  schedule="$(get_field "$source_dir/WORKFLOW.md" schedule)"
  if [ -n "$schedule" ]; then
    local oc
    oc="$(_find_openclaw)"
    if [ -n "$oc" ] && ! "$oc" cron list </dev/null 2>/dev/null | grep -q "clawflows-scheduler"; then
      "$oc" cron add \
        --name "clawflows-scheduler" \
        --cron "*/15 * * * *" \
        --session isolated \
        --message "Read and execute $CLAWFLOWS_DIR/system/scheduler.md" \
        --no-deliver </dev/null >/dev/null 2>&1 || true
      echo "scheduler started (checks every 15 min)"
    fi
  fi

  cmd_sync
}

cmd_disable() {
  local name="$1"
  if [ ! -L "$ENABLED_DIR/$name" ] && [ ! -d "$ENABLED_DIR/$name" ]; then
    echo "not enabled: $name"
    return
  fi

  # Remove symlink (or directory if somehow it's not a symlink)
  rm -rf "$ENABLED_DIR/$name"
  echo "disabled: $name"
  cmd_sync
}

cmd_edit() {
  local name="$1"

  # Already in custom? Just show the path
  if [ -d "$CUSTOM_DIR/$name" ]; then
    echo "workflow is in custom/: $name"
    echo ""
    echo "  Edit: $CUSTOM_DIR/$name/WORKFLOW.md"
    return
  fi

  # In community? Copy to custom
  if [ -d "$COMMUNITY_DIR/$name" ]; then
    cp -r "$COMMUNITY_DIR/$name" "$CUSTOM_DIR/$name"
    echo "copied to custom/: $name"

    # If it was enabled, update the symlink to point to custom/
    if [ -L "$ENABLED_DIR/$name" ]; then
      rm "$ENABLED_DIR/$name"
      ln -s "$CUSTOM_DIR/$name" "$ENABLED_DIR/$name"
      echo "updated symlink to custom version"
    fi

    echo ""
    echo "  Edit: $CUSTOM_DIR/$name/WORKFLOW.md"
    echo "  Your changes won't be overwritten by updates."
    return
  fi

  die "workflow '$name' not found"
}

cmd_open() {
  local name="$1"
  local wf_file=""

  # Find the workflow file (custom takes priority)
  if [ -d "$CUSTOM_DIR/$name" ]; then
    wf_file="$CUSTOM_DIR/$name/WORKFLOW.md"
  elif [ -d "$COMMUNITY_DIR/$name" ]; then
    # It's a community workflow - suggest editing first
    echo "note: '$name' is a community workflow"
    echo "      Changes will be lost on update. Run 'clawflows edit $name' first to make it editable."
    echo ""
    wf_file="$COMMUNITY_DIR/$name/WORKFLOW.md"
  else
    die "workflow '$name' not found"
  fi

  [ -f "$wf_file" ] || die "WORKFLOW.md not found at $wf_file"

  # Find an editor
  local editor="${EDITOR:-}"
  if [ -z "$editor" ]; then
    # Try common editors
    for e in code vim nano vi; do
      if command -v "$e" >/dev/null 2>&1; then
        editor="$e"
        break
      fi
    done
  fi

  if [ -z "$editor" ]; then
    echo "No editor found. Set \$EDITOR or install vim/nano."
    echo ""
    echo "  File: $wf_file"
    return 1
  fi

  echo "Opening $wf_file..."
  $editor "$wf_file"
}

cmd_update() {
  echo "Updating clawflows..."
  if git -C "$CLAWFLOWS_DIR" pull --ff-only --quiet 2>/dev/null; then
    echo "Updated to latest version."
  else
    echo "Could not update (offline or local changes). Try: git -C $CLAWFLOWS_DIR pull"
    return 1
  fi
  cmd_sync
}

cmd_uninstall() {
  echo ""
  echo "  This will remove:"
  echo "    â€¢ CLI symlink at $BIN_TARGET"
  echo "    â€¢ ClawFlows section from AGENTS.md"
  echo "    â€¢ Scheduler cron job"
  echo ""
  echo "  Your custom workflows in $CUSTOM_DIR/ will NOT be deleted."
  echo "  The repo at $CLAWFLOWS_DIR/ will NOT be deleted."
  echo ""
  printf "  Are you sure? [y/N] "
  read -r confirm
  if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
    echo "  Cancelled."
    return
  fi

  if [ -L "$BIN_TARGET" ]; then
    rm -f "$BIN_TARGET"
    echo "  Removed $BIN_TARGET"
  fi

  if [ -f "$AGENTS_MD" ] && grep -qF "$START_MARKER" "$AGENTS_MD"; then
    local tmpfile
    tmpfile="$(mktemp)"
    awk -v start="$START_MARKER" -v end="$END_MARKER" '
      $0 == start { skip=1; next }
      $0 == end   { skip=0; next }
      !skip       { print }
    ' "$AGENTS_MD" > "$tmpfile"
    mv "$tmpfile" "$AGENTS_MD"
    echo "  Removed ClawFlows section from AGENTS.md"
  fi

  local oc
  oc="$(_find_openclaw)"
  if [ -n "$oc" ]; then
    "$oc" cron remove --name "clawflows-scheduler" </dev/null >/dev/null 2>&1 || true
    echo "  Removed scheduler cron"
  fi

  echo ""
  echo "  Done. To fully remove, also run:"
  echo "    rm -rf $CLAWFLOWS_DIR"
  echo ""
  echo "  âš ï¸  Warning: This will delete any custom workflows you created."
  echo "     Back up $CUSTOM_DIR/ first if you want to keep them."
  echo ""
}

cmd_sync() {
  local block
  block="$(_build_block)"

  if [ ! -f "$AGENTS_MD" ]; then
    echo "note: AGENTS.md not found at $AGENTS_MD (skipping sync)"
    return 0
  fi

  if grep -qF "$START_MARKER" "$AGENTS_MD"; then
    _replace_block "$block"
  else
    printf "\n%s\n" "$block" >> "$AGENTS_MD"
  fi

  echo "synced AGENTS.md"
}

# â”€â”€ Block builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

_build_block() {
  local lines=()

  lines+=("$START_MARKER")
  lines+=("## ClawFlows")
  lines+=("")
  lines+=("Workflows from \`$CLAWFLOWS_DIR/\`. When the user asks you to do something that matches an enabled workflow, read its WORKFLOW.md and follow the steps.")
  lines+=("")
  lines+=("### Running a Workflow")
  lines+=("1. Read the WORKFLOW.md file listed next to the workflow below")
  lines+=("2. Follow the steps in the file exactly")
  lines+=("3. If the workflow isn't enabled yet, run \`clawflows enable <name>\` first")
  lines+=("")
  lines+=("### CLI Commands")
  lines+=("- \`clawflows list\` â€” see all workflows")
  lines+=("- \`clawflows enable <name>\` â€” turn on a workflow")
  lines+=("- \`clawflows disable <name>\` â€” turn off a workflow")
  lines+=("- \`clawflows create\` â€” create a new custom workflow")
  lines+=("- \`clawflows edit <name>\` â€” copy a community workflow to custom/ for editing")
  lines+=("- \`clawflows open <name>\` â€” open a workflow in your editor")
  lines+=("- \`clawflows validate <name>\` â€” check a workflow has required fields")
  lines+=("- \`clawflows submit <name>\` â€” submit a custom workflow for community review")
  lines+=("- \`clawflows backup\` â€” back up custom workflows and enabled list")
  lines+=("- \`clawflows restore\` â€” restore from a backup")
  lines+=("- \`clawflows update\` â€” pull the latest community workflows")
  lines+=("- \`clawflows sync-agent\` â€” refresh your agent's workflow list in AGENTS.md")
  lines+=("")
  lines+=("### Sharing Workflows")
  lines+=("When the user wants to share or submit a workflow to the community:")
  lines+=("1. Create the workflow: \`clawflows create\`")
  lines+=("2. Test it: \`clawflows run <name>\`")
  lines+=("3. Submit it: \`clawflows submit <name>\`")
  lines+=("4. Follow the PR instructions shown after submit")
  lines+=("")

  local has_enabled=false
  local entries=()
  for link in "$ENABLED_DIR"/*/; do
    [ -d "$link" ] || continue
    local name desc schedule wf_file target_dir
    name="$(basename "$link")"
    [ "$name" = ".gitkeep" ] && continue

    # Resolve symlink to get actual path
    if [ -L "$link" ]; then
      target_dir="$(readlink "$link")"
    else
      target_dir="$link"
    fi

    wf_file="$target_dir/WORKFLOW.md"
    [ -f "$wf_file" ] || wf_file="$link/WORKFLOW.md"
    [ -f "$wf_file" ] || continue

    desc="$(get_field "$wf_file" description)"
    schedule="$(get_field "$wf_file" schedule)"
    if [ -n "$schedule" ]; then
      entries+=("- **$name** ($schedule): $desc â†’ \`$wf_file\`")
    else
      entries+=("- **$name** (on-demand): $desc â†’ \`$wf_file\`")
    fi
    has_enabled=true
  done

  if $has_enabled; then
    lines+=("### Enabled Workflows")
    lines+=("When the user asks for any of these, read the WORKFLOW.md file and follow it.")
    for entry in "${entries[@]}"; do
      lines+=("$entry")
    done
  else
    lines+=("No workflows enabled yet. Run \`clawflows list\` to see what's available.")
  fi

  lines+=("$END_MARKER")

  printf '%s\n' "${lines[@]}"
}

_replace_block() {
  local new_block="$1"
  local tmpfile blockfile
  tmpfile="$(mktemp)"
  blockfile="$(mktemp)"

  printf '%s\n' "$new_block" > "$blockfile"

  awk -v start="$START_MARKER" -v end="$END_MARKER" -v bf="$blockfile" '
    $0 == start { while ((getline line < bf) > 0) print line; close(bf); skip=1; next }
    $0 == end   { skip=0; next }
    !skip       { print }
  ' "$AGENTS_MD" > "$tmpfile"

  mv "$tmpfile" "$AGENTS_MD"
  rm -f "$blockfile"
}

cmd_backup() {
  local filename="${1:-}"
  local timestamp
  timestamp="$(date +%Y-%m-%d-%H%M%S)"

  if [ -z "$filename" ]; then
    filename="clawflows-$timestamp.tar.gz"
  elif [[ "$filename" != *.tar.gz ]]; then
    filename="$filename.tar.gz"
  fi

  mkdir -p "$BACKUP_DIR"

  local tmpdir
  tmpdir="$(mktemp -d)"

  # Copy custom workflows
  if [ -d "$CUSTOM_DIR" ] && [ "$(ls -A "$CUSTOM_DIR" 2>/dev/null | grep -v '.gitkeep')" ]; then
    mkdir -p "$tmpdir/custom"
    for wf in "$CUSTOM_DIR"/*/; do
      [ -d "$wf" ] || continue
      local name="$(basename "$wf")"
      [ "$name" = ".gitkeep" ] && continue
      # Remove trailing slash to copy the directory itself, not just contents
      cp -r "${wf%/}" "$tmpdir/custom/"
    done
  else
    mkdir -p "$tmpdir/custom"
  fi

  # Save enabled workflows list
  : > "$tmpdir/enabled-workflows.txt"
  for link in "$ENABLED_DIR"/*/; do
    [ -d "$link" ] || continue
    local name="$(basename "$link")"
    [ "$name" = ".gitkeep" ] && continue
    echo "$name" >> "$tmpdir/enabled-workflows.txt"
  done

  # Create archive
  tar -czf "$BACKUP_DIR/$filename" -C "$tmpdir" .
  rm -rf "$tmpdir"

  # Count what we backed up
  local custom_count=0
  for wf in "$CUSTOM_DIR"/*/; do
    [ -d "$wf" ] || continue
    [ "$(basename "$wf")" = ".gitkeep" ] && continue
    ((custom_count++)) || true
  done

  local enabled_count=0
  for link in "$ENABLED_DIR"/*/; do
    [ -d "$link" ] || continue
    [ "$(basename "$link")" = ".gitkeep" ] && continue
    ((enabled_count++)) || true
  done

  echo ""
  echo "  Backup created"
  echo ""
  echo "    Custom workflows: $custom_count"
  echo "    Enabled workflows: $enabled_count"
  echo ""
  echo "    $BACKUP_DIR/$filename"
  echo ""
}

cmd_restore() {
  local file="${1:-}"

  # List available backups if none specified
  if [ -z "$file" ]; then
    if [ ! -d "$BACKUP_DIR" ] || [ -z "$(ls -A "$BACKUP_DIR" 2>/dev/null)" ]; then
      echo ""
      echo "  No backups found in $BACKUP_DIR"
      echo "  Run 'clawflows backup' to create one."
      echo ""
      return 1
    fi

    echo ""
    echo "  Available backups:"
    echo ""
    local i=1
    local backups=()
    # Sort newest first (reverse alphabetical since filenames have timestamps)
    for f in $(ls -r "$BACKUP_DIR"/*.tar.gz 2>/dev/null); do
      [ -f "$f" ] || continue
      backups+=("$f")
      local name="$(basename "$f")"
      if [ $i -eq 1 ]; then
        echo "    $i. $name (latest)"
      else
        echo "    $i. $name"
      fi
      ((i++))
    done

    if [ ${#backups[@]} -eq 0 ]; then
      echo "  No backups found."
      echo ""
      return 1
    fi

    echo ""
    printf "  Restore which backup? [1]: "
    read -r choice
    choice="${choice:-1}"

    if [[ ! "$choice" =~ ^[0-9]+$ ]] || [ "$choice" -lt 1 ] || [ "$choice" -gt ${#backups[@]} ]; then
      echo "  Cancelled."
      return 1
    fi

    file="${backups[$((choice-1))]}"
  fi

  # Handle "latest"
  if [ "$file" = "latest" ]; then
    file="$(ls -r "$BACKUP_DIR"/*.tar.gz 2>/dev/null | head -1)"
    [ -n "$file" ] || die "no backups found"
  fi

  # Resolve relative path
  if [ ! -f "$file" ] && [ -f "$BACKUP_DIR/$file" ]; then
    file="$BACKUP_DIR/$file"
  fi

  [ -f "$file" ] || die "backup not found: $file"

  echo ""
  echo "  Restoring from $(basename "$file")..."

  local tmpdir
  tmpdir="$(mktemp -d)"
  tar -xzf "$file" -C "$tmpdir"

  # Restore custom workflows
  local restored=0
  local skipped=0
  if [ -d "$tmpdir/custom" ]; then
    for wf in "$tmpdir/custom"/*/; do
      [ -d "$wf" ] || continue
      local name="$(basename "$wf")"
      [ "$name" = ".gitkeep" ] && continue

      if [ -d "$CUSTOM_DIR/$name" ]; then
        ((skipped++)) || true
      else
        # Remove trailing slash to copy the directory itself, not just contents
        cp -r "${wf%/}" "$CUSTOM_DIR/"
        ((restored++)) || true
      fi
    done
  fi

  # Re-enable workflows
  local enabled=0
  if [ -f "$tmpdir/enabled-workflows.txt" ]; then
    while IFS= read -r name || [ -n "$name" ]; do
      [ -z "$name" ] && continue
      if [ -L "$ENABLED_DIR/$name" ] || [ -d "$ENABLED_DIR/$name" ]; then
        continue  # already enabled
      fi
      local source_dir
      source_dir="$(_find_workflow "$name")"
      if [ -n "$source_dir" ]; then
        ln -s "$source_dir" "$ENABLED_DIR/$name"
        ((enabled++)) || true
      fi
    done < "$tmpdir/enabled-workflows.txt"
  fi

  rm -rf "$tmpdir"

  # Sync AGENTS.md if we enabled anything
  if [ $enabled -gt 0 ]; then
    cmd_sync >/dev/null 2>&1 || true
  fi

  echo ""
  echo "  Restored $restored custom workflow(s)"
  [ $skipped -gt 0 ] && echo "  Skipped $skipped (already exist)"
  echo "  Enabled $enabled workflow(s)"
  echo ""
}

cmd_validate() {
  local name="$1"
  local wf_dir wf_file errors=0

  # Find the workflow
  wf_dir="$(_find_workflow "$name")"
  [ -n "$wf_dir" ] || die "workflow '$name' not found"

  wf_file="$wf_dir/WORKFLOW.md"
  [ -f "$wf_file" ] || die "WORKFLOW.md not found at $wf_file"

  echo ""
  echo "  Validating $name..."
  echo ""

  # Check frontmatter exists
  if ! head -1 "$wf_file" | grep -q '^---$'; then
    echo "  âœ— Missing frontmatter (file must start with ---)"
    errors=1
  fi

  # Check required fields
  local field_name field_emoji field_desc
  field_name="$(get_field "$wf_file" name)"
  field_emoji="$(get_field "$wf_file" emoji)"
  field_desc="$(get_field "$wf_file" description)"

  if [ -z "$field_name" ]; then
    echo "  âœ— Missing required field: name"
    errors=1
  else
    echo "  âœ“ name: $field_name"
  fi

  if [ -z "$field_emoji" ]; then
    echo "  âœ— Missing required field: emoji"
    errors=1
  else
    echo "  âœ“ emoji: $field_emoji"
  fi

  if [ -z "$field_desc" ]; then
    echo "  âœ— Missing required field: description"
    errors=1
  else
    echo "  âœ“ description: $field_desc"
  fi

  echo ""

  if [ $errors -eq 0 ]; then
    echo "  âœ“ Workflow is valid!"
    echo ""
    return 0
  else
    echo "  âœ— Validation failed"
    echo ""
    return 1
  fi
}

cmd_submit() {
  local name="$1"

  # Check if workflow exists in custom/
  if [ ! -d "$CUSTOM_DIR/$name" ]; then
    if [ -d "$COMMUNITY_DIR/$name" ]; then
      die "workflow '$name' is already a community workflow"
    fi
    die "workflow '$name' not found in custom/. Create one with: clawflows create"
  fi

  # Validate before submitting
  if ! cmd_validate "$name"; then
    die "fix validation errors before submitting"
  fi

  local source_dir="$CUSTOM_DIR/$name"
  local target_dir="$SUBMISSIONS_DIR/$name"

  # Check if already submitted
  if [ -d "$target_dir" ]; then
    die "workflow '$name' has already been submitted. Check $target_dir"
  fi

  # Copy to submissions
  mkdir -p "$SUBMISSIONS_DIR"
  cp -r "$source_dir" "$target_dir"

  echo ""
  echo "  Workflow copied to community-submissions/"
  echo ""
  echo "  $target_dir/WORKFLOW.md"
  echo ""
  echo "  Next steps:"
  echo "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
  echo "  1. Fork this repo (if you haven't already)"
  echo "     https://github.com/davehappyminion/clawflows/fork"
  echo ""
  echo "  2. Commit and push your changes:"
  echo "     git add community-submissions/$name"
  echo "     git commit -m \"Add $name workflow\""
  echo "     git push"
  echo ""
  echo "  3. Open a pull request:"
  echo "     https://github.com/davehappyminion/clawflows/compare"
  echo ""
  echo "  Thanks for contributing!"
  echo ""
}

cmd_run() {
  local name="$1"
  local wf_file

  # Find the workflow
  if [ -L "$ENABLED_DIR/$name" ] || [ -d "$ENABLED_DIR/$name" ]; then
    wf_file="$ENABLED_DIR/$name/WORKFLOW.md"
  elif [ -d "$CUSTOM_DIR/$name" ]; then
    # Auto-enable if in custom but not enabled
    echo "Enabling $name..."
    cmd_enable "$name"
    wf_file="$ENABLED_DIR/$name/WORKFLOW.md"
  elif [ -d "$COMMUNITY_DIR/$name" ]; then
    # Auto-enable if in community but not enabled
    echo "Enabling $name..."
    cmd_enable "$name"
    wf_file="$ENABLED_DIR/$name/WORKFLOW.md"
  else
    die "workflow '$name' not found"
  fi

  [ -f "$wf_file" ] || die "WORKFLOW.md not found at $wf_file"

  # Run via openclaw if available
  local oc
  oc="$(_find_openclaw)"
  if [ -n "$oc" ]; then
    echo "Running $name..."
    echo ""
    "$oc" agent --agent main -m "Run the $name workflow by following $wf_file"
  else
    echo ""
    echo "  âœ“ Workflow ready: $name"
    echo ""
    echo "  To run it, tell your agent:"
    echo ""
    echo "    Run $name"
    echo ""
  fi
}

# â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[ $# -ge 1 ] || { cmd_help; exit 0; }

case "$1" in
  list)      cmd_list "${2:-all}" ;;
  create)    cmd_create "${2:-}" "${3:-}" ;;
  run)       [ $# -ge 2 ] || die "usage: clawflows run <name>"; cmd_run "$2" ;;
  enable)    [ $# -ge 2 ] || die "usage: clawflows enable <name>"; cmd_enable "$2" ;;
  disable)   [ $# -ge 2 ] || die "usage: clawflows disable <name>"; cmd_disable "$2" ;;
  edit)      [ $# -ge 2 ] || die "usage: clawflows edit <name>"; cmd_edit "$2" ;;
  open)      [ $# -ge 2 ] || die "usage: clawflows open <name>"; cmd_open "$2" ;;
  validate)  [ $# -ge 2 ] || die "usage: clawflows validate <name>"; cmd_validate "$2" ;;
  submit)    [ $# -ge 2 ] || die "usage: clawflows submit <name>"; cmd_submit "$2" ;;
  backup)    cmd_backup "${2:-}" ;;
  restore)   cmd_restore "${2:-}" ;;
  update)    cmd_update ;;
  uninstall) cmd_uninstall ;;
  sync-agent) cmd_sync ;;
  help|--help|-h) cmd_help ;;
  *)         cmd_help ;;
esac
