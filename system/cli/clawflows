#!/usr/bin/env bash
set -euo pipefail

# â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Resolve symlinks so this works when called via ~/.local/bin/clawflows
SELF="$0"
if [ -L "$SELF" ]; then
  SELF="$(readlink "$SELF")"
fi
CLAWFLOWS_DIR="$(cd "$(dirname "$SELF")/../.." && pwd)"
AGENTS_MD="${AGENTS_MD:-$HOME/.openclaw/workspace/AGENTS.md}"
COMMUNITY_DIR="$CLAWFLOWS_DIR/workflows/available/community"
CUSTOM_DIR="$CLAWFLOWS_DIR/workflows/available/custom"
ENABLED_DIR="$CLAWFLOWS_DIR/workflows/enabled"
BIN_TARGET="$HOME/.local/bin/clawflows"

START_MARKER="<!-- clawflows:start -->"
END_MARKER="<!-- clawflows:end -->"

# â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cmd_help() {
  cat <<'EOF'

  âš¡ï¸ ClawFlows â€” Superpowers for your OpenClaw agent

  Usage: clawflows <command> [args]

  Browsing
    list                 Show all workflows (enabled + available)
    list enabled         Show only enabled workflows
    list available       Show only available workflows

  Creating
    create               Create a new custom workflow (interactive)
    create --from-json   Create from JSON (for agents)

  Managing
    enable <name>        Turn on a workflow (symlinks to enabled/)
    disable <name>       Turn off a workflow (removes symlink)
    customize <name>     Copy a community workflow to custom/ for editing

  Maintenance
    update               Pull the latest workflows from GitHub
    sync                 Refresh your agent's workflow list in AGENTS.md
    uninstall            Remove clawflows and clean up

  Info
    help, --help, -h     Show this help

  Examples
    clawflows create                        Create a new custom workflow
    clawflows list                          See everything
    clawflows enable send-morning-briefing  Turn on morning briefings
    clawflows customize send-morning-briefing  Make your own version
    clawflows disable check-x               Turn off X/Twitter workflow
    clawflows update                        Get new community workflows

  How it works
    Workflows live in ~/.openclaw/workspace/clawflows/workflows/
    â€¢ available/community/  â€” from the repo (updated via git)
    â€¢ available/custom/     â€” your own workflows (gitignored)
    â€¢ enabled/              â€” symlinks to active workflows

    When you enable a workflow, a symlink is created. Disable removes
    the symlink â€” your custom workflows are never deleted.

    Use 'customize' to copy a community workflow to custom/ so you
    can edit it without losing changes on update.

EOF
}

die() { echo "error: $1" >&2; exit 1; }

# Extract a frontmatter field from a WORKFLOW.md file.
get_field() {
  local file="$1" field="$2"
  awk -v field="$field" '
    BEGIN { in_fm=0 }
    /^---$/ { in_fm++; next }
    in_fm == 1 && $0 ~ "^" field ":" {
      sub("^" field ":[ ]*", "")
      gsub(/^["'"'"']|["'"'"']$/, "")
      print
      exit
    }
    in_fm >= 2 { exit }
  ' "$file"
}

# Find workflow source: custom/ takes priority over community/
_find_workflow() {
  local name="$1"
  if [ -d "$CUSTOM_DIR/$name" ]; then
    echo "$CUSTOM_DIR/$name"
  elif [ -d "$COMMUNITY_DIR/$name" ]; then
    echo "$COMMUNITY_DIR/$name"
  fi
}

# Build a line for a workflow: emoji + name + description
_workflow_line() {
  local dir="$1"
  local name emoji desc label
  name="$(basename "$dir")"
  emoji=""
  desc=""
  if [ -f "$dir/WORKFLOW.md" ]; then
    emoji="$(get_field "$dir/WORKFLOW.md" emoji)"
    desc="$(get_field "$dir/WORKFLOW.md" description)"
  fi
  label="${emoji:+$emoji }$name"
  if [ -n "$desc" ]; then
    printf "    %-40s %s" "$label" "$desc"
  else
    printf "    %s" "$label"
  fi
}

# â”€â”€ Commands â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# Create workflow from JSON (for agent/programmatic use)
_create_from_json() {
  local json="$1"

  if [ -z "$json" ]; then
    json="$(cat)"
  fi

  if [ -z "$json" ]; then
    die "No JSON provided. Usage: clawflows create --from-json '{...}' or pipe JSON to stdin"
  fi

  # Parse JSON fields
  local name emoji summary schedule author description
  name="$(echo "$json" | grep -o '"name"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/.*:.*"\([^"]*\)"/\1/' | head -1)"
  emoji="$(echo "$json" | grep -o '"emoji"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/.*:.*"\([^"]*\)"/\1/' | head -1)"
  summary="$(echo "$json" | grep -o '"summary"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/.*:.*"\([^"]*\)"/\1/' | head -1)"
  schedule="$(echo "$json" | grep -o '"schedule"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/.*:.*"\([^"]*\)"/\1/' | head -1)"
  author="$(echo "$json" | grep -o '"author"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/.*:.*"\([^"]*\)"/\1/' | head -1)"
  description="$(echo "$json" | grep -o '"description"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/.*:.*"\([^"]*\)"/\1/' | head -1)"

  # Validate required fields
  [ -n "$name" ] || die "Missing required field: name"
  [ -n "$summary" ] || die "Missing required field: summary"
  [ -n "$description" ] || die "Missing required field: description"

  # Defaults
  emoji="${emoji:-ğŸ”§}"

  # Check if already exists
  if [ -d "$CUSTOM_DIR/$name" ] || [ -d "$COMMUNITY_DIR/$name" ]; then
    die "Workflow '$name' already exists"
  fi

  # Build the WORKFLOW.md content
  local workflow_content="---
name: $name
emoji: $emoji
description: $summary"

  if [ -n "$schedule" ]; then
    workflow_content="$workflow_content
schedule: \"$schedule\""
  fi

  if [ -n "$author" ]; then
    workflow_content="$workflow_content
author: $author"
  fi

  local title
  title="$(echo "${name//-/ }" | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2))}1')"

  workflow_content="$workflow_content
---

# $title

$description
"

  # Create in custom/ directory
  local workflow_dir="$CUSTOM_DIR/$name"
  mkdir -p "$workflow_dir"
  printf '%s' "$workflow_content" > "$workflow_dir/WORKFLOW.md"

  echo "âœ“ Created $workflow_dir/WORKFLOW.md"

  # Auto-enable it
  cmd_enable "$name"
}

cmd_create() {
  if [ "${1:-}" = "--from-json" ]; then
    _create_from_json "${2:-}"
    return
  fi

  echo ""
  echo "  âš¡ï¸ Create a new workflow"
  echo ""

  # 1. Name
  local name=""
  while [ -z "$name" ]; do
    printf "  Name (e.g., check-water-intake): "
    read -r name
    if [ -n "$name" ]; then
      name="$(echo "$name" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')"
      if ! echo "$name" | grep -qE '^(activate|process|check|build|send|sync|track|draft|review|plan|prep|curate|summarize|backup|clean|rotate|find)-'; then
        echo "  âš ï¸  Name should start with a verb (check-, send-, build-, process-, etc.)"
        printf "  Continue anyway? [y/N] "
        read -r confirm
        if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
          name=""
          continue
        fi
      fi
      if [ -d "$CUSTOM_DIR/$name" ] || [ -d "$COMMUNITY_DIR/$name" ]; then
        echo "  âš ï¸  Workflow '$name' already exists"
        name=""
        continue
      fi
    fi
  done

  # 2. Emoji
  printf "  Emoji (e.g., ğŸ’§): "
  read -r emoji
  emoji="${emoji:-ğŸ”§}"

  # 3. Summary
  local summary=""
  while [ -z "$summary" ]; do
    printf "  One-line summary: "
    read -r summary
  done

  # 4. Schedule
  echo ""
  echo "  When should it run?"
  echo "    Examples: \"9am\", \"9am, 5pm\", \"8am, 12pm, 4pm, 8pm\""
  echo "    Leave blank for on-demand only"
  printf "  Schedule: "
  read -r schedule

  # 5. Author
  echo ""
  echo "  Author (optional)"
  echo "    GitHub username, @twitter, or both: \"nikilster @nikil\""
  printf "  Author: "
  read -r author

  # 6. Description
  echo ""
  echo "  Describe what this workflow does."
  echo "  What should the agent do when running it? Be specific."
  echo "  (Enter a blank line when done)"
  echo ""
  local description=""
  local line
  while IFS= read -r line; do
    [ -z "$line" ] && break
    if [ -z "$description" ]; then
      description="$line"
    else
      description="$description"$'\n'"$line"
    fi
  done

  # Build content
  local workflow_content="---
name: $name
emoji: $emoji
description: $summary"

  if [ -n "$schedule" ]; then
    workflow_content="$workflow_content
schedule: \"$schedule\""
  fi

  if [ -n "$author" ]; then
    workflow_content="$workflow_content
author: $author"
  fi

  local title
  title="$(echo "${name//-/ }" | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2))}1')"

  workflow_content="$workflow_content
---

# $title

$description
"

  # Create in custom/ directory
  local workflow_dir="$CUSTOM_DIR/$name"
  mkdir -p "$workflow_dir"
  printf '%s' "$workflow_content" > "$workflow_dir/WORKFLOW.md"

  echo ""
  echo "  âœ“ Created $workflow_dir/WORKFLOW.md"
  echo ""
  echo "  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "$workflow_content" | sed 's/^/  /'
  echo "  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""

  # Auto-enable
  cmd_enable "$name"

  echo ""
  echo "  Your workflow is ready! Ask your agent to run it or edit the file to refine."
  echo ""
}

cmd_list() {
  local filter="${1:-all}"
  local name found=false
  local enabled_lines=()
  local available_lines=()

  # Collect all available workflows (custom takes priority)
  declare -A all_workflows
  for dir in "$COMMUNITY_DIR"/*/; do
    [ -d "$dir" ] || continue
    name="$(basename "$dir")"
    all_workflows["$name"]="$dir"
  done
  for dir in "$CUSTOM_DIR"/*/; do
    [ -d "$dir" ] || continue
    name="$(basename "$dir")"
    all_workflows["$name"]="$dir"
  done

  for name in "${!all_workflows[@]}"; do
    found=true
    dir="${all_workflows[$name]}"

    if [ -L "$ENABLED_DIR/$name" ] || [ -d "$ENABLED_DIR/$name" ]; then
      enabled_lines+=("$(_workflow_line "$dir")")
    else
      available_lines+=("$(_workflow_line "$dir")")
    fi
  done

  if ! $found; then
    echo ""
    echo "  No workflows found."
    echo ""
    echo "  Make sure clawflows is installed correctly:"
    echo "    curl -fsSL https://raw.githubusercontent.com/davehappyminion/clawflows/main/system/install.sh | bash"
    echo ""
    return
  fi

  if [ "$filter" = "all" ] || [ "$filter" = "enabled" ]; then
    if [ ${#enabled_lines[@]} -gt 0 ]; then
      echo ""
      echo "  Enabled (${#enabled_lines[@]})"
      echo "  â”€â”€â”€â”€â”€â”€â”€â”€â”€"
      for line in "${enabled_lines[@]}"; do
        echo "$line"
      done
    elif [ "$filter" = "enabled" ]; then
      echo ""
      echo "  No workflows enabled yet."
      echo "  Run 'clawflows list' to see what's available."
    fi
  fi

  if [ "$filter" = "all" ] || [ "$filter" = "available" ]; then
    if [ ${#available_lines[@]} -gt 0 ]; then
      echo ""
      echo "  Available (${#available_lines[@]})"
      echo "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
      for line in "${available_lines[@]}"; do
        echo "$line"
      done
    fi
  fi

  echo ""
  echo "  clawflows enable <name>    Turn on a workflow"
  echo "  clawflows disable <name>   Turn off a workflow"
}

cmd_enable() {
  local name="$1"
  local source_dir
  source_dir="$(_find_workflow "$name")"

  [ -n "$source_dir" ] || die "workflow '$name' not found"

  if [ -L "$ENABLED_DIR/$name" ] || [ -d "$ENABLED_DIR/$name" ]; then
    echo "already enabled: $name"
    return
  fi

  # Create symlink
  ln -s "$source_dir" "$ENABLED_DIR/$name"
  echo "enabled: $name"
  cmd_sync
}

cmd_disable() {
  local name="$1"
  if [ ! -L "$ENABLED_DIR/$name" ] && [ ! -d "$ENABLED_DIR/$name" ]; then
    echo "not enabled: $name"
    return
  fi

  # Remove symlink (or directory if somehow it's not a symlink)
  rm -rf "$ENABLED_DIR/$name"
  echo "disabled: $name"
  cmd_sync
}

cmd_customize() {
  local name="$1"

  # Must exist in community/
  if [ ! -d "$COMMUNITY_DIR/$name" ]; then
    die "workflow '$name' not found in community/"
  fi

  # Already customized?
  if [ -d "$CUSTOM_DIR/$name" ]; then
    echo "already customized: $name (exists in custom/)"
    return
  fi

  # Copy to custom/
  cp -r "$COMMUNITY_DIR/$name" "$CUSTOM_DIR/$name"
  echo "copied to custom/: $name"

  # If it was enabled, update the symlink to point to custom/
  if [ -L "$ENABLED_DIR/$name" ]; then
    rm "$ENABLED_DIR/$name"
    ln -s "$CUSTOM_DIR/$name" "$ENABLED_DIR/$name"
    echo "updated symlink to custom version"
  fi

  echo ""
  echo "  Edit: $CUSTOM_DIR/$name/WORKFLOW.md"
  echo "  Your changes won't be overwritten by updates."
}

cmd_update() {
  echo "Updating clawflows..."
  if git -C "$CLAWFLOWS_DIR" pull --ff-only --quiet 2>/dev/null; then
    echo "Updated to latest version."
  else
    echo "Could not update (offline or local changes). Try: git -C $CLAWFLOWS_DIR pull"
    return 1
  fi
  cmd_sync
}

cmd_uninstall() {
  echo ""
  echo "  This will remove:"
  echo "    â€¢ CLI symlink at $BIN_TARGET"
  echo "    â€¢ ClawFlows section from AGENTS.md"
  echo "    â€¢ Scheduler cron job"
  echo ""
  echo "  Your custom workflows in $CUSTOM_DIR/ will NOT be deleted."
  echo "  The repo at $CLAWFLOWS_DIR/ will NOT be deleted."
  echo ""
  printf "  Are you sure? [y/N] "
  read -r confirm
  if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
    echo "  Cancelled."
    return
  fi

  if [ -L "$BIN_TARGET" ]; then
    rm -f "$BIN_TARGET"
    echo "  Removed $BIN_TARGET"
  fi

  if [ -f "$AGENTS_MD" ] && grep -qF "$START_MARKER" "$AGENTS_MD"; then
    local tmpfile
    tmpfile="$(mktemp)"
    awk -v start="$START_MARKER" -v end="$END_MARKER" '
      $0 == start { skip=1; next }
      $0 == end   { skip=0; next }
      !skip       { print }
    ' "$AGENTS_MD" > "$tmpfile"
    mv "$tmpfile" "$AGENTS_MD"
    echo "  Removed ClawFlows section from AGENTS.md"
  fi

  if command -v openclaw >/dev/null 2>&1; then
    openclaw cron remove --name "clawflows-scheduler" </dev/null >/dev/null 2>&1 || true
    echo "  Removed scheduler cron"
  fi

  echo ""
  echo "  Done. To fully remove, also run:"
  echo "    rm -rf $CLAWFLOWS_DIR"
  echo ""
  echo "  âš ï¸  Warning: This will delete any custom workflows you created."
  echo "     Back up $CUSTOM_DIR/ first if you want to keep them."
  echo ""
}

cmd_sync() {
  local block
  block="$(_build_block)"

  if [ ! -f "$AGENTS_MD" ]; then
    die "AGENTS.md not found at $AGENTS_MD"
  fi

  if grep -qF "$START_MARKER" "$AGENTS_MD"; then
    _replace_block "$block"
  else
    printf "\n%s\n" "$block" >> "$AGENTS_MD"
  fi

  echo "synced AGENTS.md"
}

# â”€â”€ Block builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

_build_block() {
  local lines=()

  lines+=("$START_MARKER")
  lines+=("## ClawFlows")
  lines+=("")
  lines+=("Workflows from \`$CLAWFLOWS_DIR/\`. When the user asks you to do something that matches an enabled workflow, read its WORKFLOW.md and follow the steps.")
  lines+=("")
  lines+=("### Running a Workflow")
  lines+=("1. Read the WORKFLOW.md file listed next to the workflow below")
  lines+=("2. Follow the steps in the file exactly")
  lines+=("3. If the workflow isn't enabled yet, run \`clawflows enable <name>\` first")
  lines+=("")
  lines+=("### CLI Commands")
  lines+=("- \`clawflows list\` â€” see all workflows")
  lines+=("- \`clawflows enable <name>\` â€” turn on a workflow")
  lines+=("- \`clawflows disable <name>\` â€” turn off a workflow")
  lines+=("- \`clawflows create\` â€” create a new custom workflow")
  lines+=("- \`clawflows customize <name>\` â€” copy a community workflow to edit")
  lines+=("- \`clawflows update\` â€” pull the latest community workflows")
  lines+=("")

  local has_enabled=false
  local entries=()
  for link in "$ENABLED_DIR"/*/; do
    [ -d "$link" ] || continue
    local name desc schedule wf_file target_dir
    name="$(basename "$link")"
    [ "$name" = ".gitkeep" ] && continue

    # Resolve symlink to get actual path
    if [ -L "$link" ]; then
      target_dir="$(readlink "$link")"
    else
      target_dir="$link"
    fi

    wf_file="$target_dir/WORKFLOW.md"
    [ -f "$wf_file" ] || wf_file="$link/WORKFLOW.md"
    [ -f "$wf_file" ] || continue

    desc="$(get_field "$wf_file" description)"
    schedule="$(get_field "$wf_file" schedule)"
    if [ -n "$schedule" ]; then
      entries+=("- **$name** ($schedule): $desc â†’ \`$wf_file\`")
    else
      entries+=("- **$name** (on-demand): $desc â†’ \`$wf_file\`")
    fi
    has_enabled=true
  done

  if $has_enabled; then
    lines+=("### Enabled Workflows")
    lines+=("When the user asks for any of these, read the WORKFLOW.md file and follow it.")
    for entry in "${entries[@]}"; do
      lines+=("$entry")
    done
  else
    lines+=("No workflows enabled yet. Run \`clawflows list\` to see what's available.")
  fi

  lines+=("$END_MARKER")

  printf '%s\n' "${lines[@]}"
}

_replace_block() {
  local new_block="$1"
  local tmpfile blockfile
  tmpfile="$(mktemp)"
  blockfile="$(mktemp)"

  printf '%s\n' "$new_block" > "$blockfile"

  awk -v start="$START_MARKER" -v end="$END_MARKER" -v bf="$blockfile" '
    $0 == start { while ((getline line < bf) > 0) print line; close(bf); skip=1; next }
    $0 == end   { skip=0; next }
    !skip       { print }
  ' "$AGENTS_MD" > "$tmpfile"

  mv "$tmpfile" "$AGENTS_MD"
  rm -f "$blockfile"
}

# â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[ $# -ge 1 ] || { cmd_help; exit 0; }

case "$1" in
  list)      cmd_list "${2:-all}" ;;
  create)    cmd_create "${2:-}" "${3:-}" ;;
  enable)    [ $# -ge 2 ] || die "usage: clawflows enable <name>"; cmd_enable "$2" ;;
  disable)   [ $# -ge 2 ] || die "usage: clawflows disable <name>"; cmd_disable "$2" ;;
  customize) [ $# -ge 2 ] || die "usage: clawflows customize <name>"; cmd_customize "$2" ;;
  update)    cmd_update ;;
  uninstall) cmd_uninstall ;;
  sync)      cmd_sync ;;
  help|--help|-h) cmd_help ;;
  *)         cmd_help ;;
esac
